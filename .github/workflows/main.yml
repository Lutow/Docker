name: CI devops 2025

on:
  push:
    branches:
      - main
      - develop
  pull_request:

jobs:
  # 1. Build and test the Java backend
  test-backend:
    runs-on: ubuntu-24.04

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'

      - name: Build and test with Maven
        run: mvn clean verify
        working-directory: "TP2 - Github Actions/simpleapi"

      - name: SonarCloud analysis
        run: mvn -B verify sonar:sonar -Dsonar.projectKey=Lutow_TP_Actions -Dsonar.organization=lutow -Dsonar.host.url=https://sonarcloud.io -Dsonar.login=${{ secrets.SONAR_TOKEN }} --file TP2 - Github Actions/simpleapi/pom.xml
        working-directory: "TP2 - Github Actions/simpleapi/"
  
  build-and-push-docker-image:
    needs: test-backend
    runs-on: ubuntu-24.04

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Login to DockerHub
        if: github.ref == 'refs/heads/main'
        run: echo "${{ secrets.DOCKER_PASSWORD }}" | docker login --username ${{ secrets.DOCKER_USERNAME }} --password-stdin

      # Build backend image
      - name: Build image and push backend
        uses: docker/build-push-action@v6
        with:
          context: "TP2 - Github Actions/simpleapi"
          tags: ${{ secrets.DOCKER_USERNAME }}/backend-api:latest
          push: ${{ github.ref == 'refs/heads/main' }}

      # Build database image
      - name: Build image and push database
        uses: docker/build-push-action@v6
        with:
          context: "TP1/Docker - database"
          tags: ${{ secrets.DOCKER_USERNAME }}/mypostgres:latest
          push: ${{ github.ref == 'refs/heads/main' }}

      # Build apache server image
      - name: Build image and push htpp server
        uses: docker/build-push-action@v6
        with:
          context: "TP1/backendapi - docker compose/apache"
          tags: ${{ secrets.DOCKER_USERNAME }}/http_server:latest
          push: ${{ github.ref == 'refs/heads/main' }}
      
